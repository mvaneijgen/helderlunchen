<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  
  <title>Helder lunchen</title>
  
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <!--[if lt IE 9]><script src="http://html5shim.googlecode.com/svn/trunk/html5.js"></script><![endif]-->

  
  
  <link rel="stylesheet" href="css/style.css" />
  <link rel="stylesheet" href="css/app.css" />
  
  <script src="js/modernizr-transitions.js"></script>
  <script src="//ajax.googleapis.com/ajax/libs/dojo/1.9.0/dojo/dojo.js" data-dojo-config="async:true,packages:[{
	name:'mustache',
    location: '/js_shared/mustache'
  },{
	name:'dlagua',
    location: '/js_shared/dojo/1.9/dlagua'
  }]"></script>
  
  <!-- scripts at bottom of page -->

</head>
<body class="homepage ">
	<nav id="site-nav"></nav> <!-- #site-nav -->
	<section id="content">

	  <div id="container" class="transitions-enabled clearfix">
	  </div> <!-- #container -->
	  
	</section>
	
    <footer id="site-footer">
      Helder lunchen <img src="img/logo.png"><a href="http://mvaneijgen.nl"> mvaneijgen</a>
    </footer>
	
    <script src="js/jquery-1.7.1.min.js"></script>
    <script src="js/jquery.masonry.js"></script>
    <script src="js/items.js"></script>
    <script>
	require([
	    "dojo/ready",
	    "dojo/hash",
	    "dojo/dom-construct",
	    "dojo/json",
	    "dojo/store/JsonRest",
	    "mustache/mustache",
	    "dojo/text!./templates/person.html",
	    "dojo/text!./templates/ingredient.html",
	    "dojo/text!./js/ingredient.schema.json",
	    "dlagua/c/string/toProperCase"
	],function(ready,hash,domConstruct,JSON,JsonRest,mustache,personTemplate,ingredientTemplate,ingredientSchema){
		var byId = function(id){
			return document.getElementById(id);
		};
		ready(function(){
			$(function(){
				var $container = $('#container');
			
				$('#mini-container').masonry({
				  columnWidth: 50
				});
			
				$container.masonry({
				  itemSelector: '.item',
				  columnWidth: 240,
				  isAnimated: !Modernizr.csstransitions
				});
			
			  // Sites using Masonry markup
			  var $sites = $('#sites'),
			  $loadingItem = $container.find('.loading');
			
			  var ajaxError = function(){
				$loadingItem.text('Could not load examples :(');
			  };
			});
			
			/* ---- store stuff ---- */
			var ingredient_schema = JSON.parse(ingredientSchema);
			
			var store = new JsonRest({
				target:"/persvr/Person/"
			});
			var name = hash();
			var person;
			var updateIngredients = function(){
				byId("ingredients").innerHTML = "";
				ingredient_schema.forEach(function(_){
					if(_.value) {
						domConstruct.create("tr",{
							innerHTML:"<td>"+_.title+"</td><td>x "+_.value+"</td>"
						},"ingredients");
					}
				});
			}
			// query store
			var q = name ? "?firstname="+name.toProperCase() : "";
			store.query(q).then(function(items){
				person = items[0];
				byId("site-nav").innerHTML = mustache.to_html(personTemplate,person);
				ingredient_schema.forEach(function(_){
					_.value = person.ingredients[_.name] || 0;
					var item = domConstruct.create("div",{
						innerHTML:mustache.to_html(ingredientTemplate,_),
						"class":"item "+_.name+" col"+_.col
					},"container");
					$('input',item).bind('change', function(evt){
						var name = evt.target.name;
						var value = parseInt(evt.target.value,10);
						person.ingredients[name] = value;
						ingredient_schema.forEach(function(_){
							_.value = person.ingredients[_.name] || 0;
						});
						updateIngredients();
					});
				});
				updateIngredients();
			});
		});
	});
    </script>
        

  </section> <!-- #content -->

</body>
</html>